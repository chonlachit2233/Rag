# app.py
import os
import streamlit as st
from groq import Groq
from qdrant_client import QdrantClient
from qdrant_client.models import PointStruct, VectorParams, Distance
from sentence_transformers import SentenceTransformer
from dotenv import load_dotenv

# 1. โหลด environment variables จากไฟล์ .env
load_dotenv()

# 2. เริ่มต้น Qdrant (แบบ In-Memory)
qdrant_client = QdrantClient(":memory:")  # ใช้ In-Memory

# สร้าง Collection สำหรับเก็บเวกเตอร์
qdrant_client.recreate_collection(
    collection_name="documents",
    vectors_config=VectorParams(size=384, distance=Distance.COSINE)  # ใช้ 384-D embedding
)

# 3. ข้อมูลเอกสารที่กำหนดเอง
documents = [
    
   "วัดหัวเวียงเหนือ ตำบลฝายแก้ว, ที่อยู่: 123 หมู่ 4 ตำบลฝายแก้ว อำเภอฝายแก้ว จังหวัดน่าน",
"วัดป่าหัด ตำบลม่วงตี๊ด, ที่อยู่: 456 หมู่ 3 ตำบลม่วงตี๊ด อำเภอแม่แตง จังหวัดน่าน",
"วัดม่วงตึ๊ด ตำบลม่วงตี๊ด, ที่อยู่: 789 หมู่ 5 ตำบลม่วงตี๊ด อำเภอแม่แตง จังหวัดน่าน",
"วัดร้องตอง ตำบลม่วงตี๊ด, ที่อยู่: 101 หมู่ 6 ตำบลม่วงตี๊ด อำเภอแม่แตง จังหวัดน่าน",
"วัดศรีบุญเรือง ตำบลม่วงตี๊ด, ที่อยู่: 102 หมู่ 7 ตำบลม่วงตี๊ด อำเภอแม่แตง จังหวัดน่าน",
"วัดทุ่งเม็ง ตำบลเมืองจัง, ที่อยู่: 103 หมู่ 8 ตำบลเมืองจัง อำเภอแม่แตง จังหวัดน่าน",
"วัดเมืองจังใต้ ตำบลเมืองจัง, ที่อยู่: 104 หมู่ 9 ตำบลเมืองจัง อำเภอแม่แตง จังหวัดน่าน",
"วัดหาดเค็ดบน ตำบลเมืองจัง, ที่อยู่: 105 หมู่ 10 ตำบลเมืองจัง อำเภอแม่แตง จังหวัดน่าน",
"วัดหาดเค็ดล่าง ตำบลเมืองจัง, ที่อยู่: 106 หมู่ 11 ตำบลเมืองจัง อำเภอแม่แตง จังหวัดน่าน",
"วัดหาดผาคำ ตำบลเมืองจัง, ที่อยู่: 107 หมู่ 12 ตำบลเมืองจัง อำเภอแม่แตง จังหวัดน่าน",
"วัดราษฎร์ในอำเภอบ่อเกลือ, ที่อยู่: 108 หมู่ 13 ตำบลบ่อเกลือ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดราษฎร์มหานิกาย, ที่อยู่: 109 หมู่ 14 ตำบลบ่อเกลือ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดนากลุ่ม ตำบลบ่อเกลือใต้, ที่อยู่: 110 หมู่ 15 ตำบลบ่อเกลือใต้ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดนาคอก ตำบลบ่อเกลือใต้, ที่อยู่: 111 หมู่ 16 ตำบลบ่อเกลือใต้ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดนาเปลื่อง (นาเปลื้อง) ตำบลบ่อเกลือใต้, ที่อยู่: 112 หมู่ 17 ตำบลบ่อเกลือใต้ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดบ่อหลวง ตำบลบ่อเกลือใต้, ที่อยู่: 113 หมู่ 18 ตำบลบ่อเกลือใต้ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดบ่อหยวก ตำบลบ่อเกลือเหนือ, ที่อยู่: 114 หมู่ 19 ตำบลบ่อเกลือเหนือ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดสะปัน ตำบลบ่อเกลือเหนือ, ที่อยู่: 115 หมู่ 20 ตำบลบ่อเกลือเหนือ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดสะว้า ตำบลบ่อเกลือเหนือ, ที่อยู่: 116 หมู่ 21 ตำบลบ่อเกลือเหนือ อำเภอบ่อเกลือ จังหวัดน่าน",
"วัดราษฎร์ในอำเภอเชียงกลาง, ที่อยู่: 117 หมู่ 22 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดราษฎร์มหานิกาย, ที่อยู่: 118 หมู่ 23 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดเจดีย์ (คาว) ตำบลเชียงกลาง, ที่อยู่: 119 หมู่ 24 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดเชียงโคม ตำบลเชียงกลาง, ที่อยู่: 120 หมู่ 25 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดม่วงสุม ตำบลเชียงกลาง, ที่อยู่: 121 หมู่ 26 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดศรีบุญเรือง ตำบลเชียงกลาง, ที่อยู่: 122 หมู่ 27 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดศรีอุดม ตำบลเชียงกลาง, ที่อยู่: 123 หมู่ 28 ตำบลเชียงกลาง อำเภอเชียงกลาง จังหวัดน่าน",
"วัดดอนแท่น ตำบลเชียงคาน, ที่อยู่: 124 หมู่ 29 ตำบลเชียงคาน อำเภอเชียงคาน จังหวัดน่าน",
"วัดใหม่วังเคียน ตำบลเชียงคาน, ที่อยู่: 125 หมู่ 30 ตำบลเชียงคาน อำเภอเชียงคาน จังหวัดน่าน",
"วัดนาหนุน ตำบลเปือ, ที่อยู่: 126 หมู่ 31 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดน้ำอ้อ ตำบลเปือ, ที่อยู่: 127 หมู่ 32 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดประดิษฐ์ ตำบลเปือ, ที่อยู่: 128 หมู่ 33 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดรัชดา ตำบลเปือ, ที่อยู่: 129 หมู่ 34 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดศรีชุม ตำบลเปือ, ที่อยู่: 130 หมู่ 35 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดหนองแดง ตำบลเปือ, ที่อยู่: 131 หมู่ 36 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดหนองผุก ตำบลเปือ, ที่อยู่: 132 หมู่ 37 ตำบลเปือ อำเภอเชียงคาน จังหวัดน่าน",
"วัดคันนา ตำบลพญาแก้ว, ที่อยู่: 133 หมู่ 38 ตำบลพญาแก้ว อำเภอเชียงคาน จังหวัดน่าน",
"วัดน้ำคา ตำบลพญาแก้ว, ที่อยู่: 134 หมู่ 39 ตำบลพญาแก้ว อำเภอเชียงคาน จังหวัดน่าน",
"วัดกลาง ตำบลพระธาตุ, ที่อยู่: 135 หมู่ 40 ตำบลพระธาตุ อำเภอเชียงคาน จังหวัดน่าน",
"วัดดอนแก้ว ตำบลพระธาตุ, ที่อยู่: 136 หมู่ 41 ตำบลพระธาตุ อำเภอเชียงคาน จังหวัดน่าน",
"วัดพร้าว ตำบลพระธาตุ, ที่อยู่: 137 หมู่ 42 ตำบลพระธาตุ อำเภอเชียงคาน จังหวัดน่าน",
"วัดสร้อยพร้าว ตำบลพระธาตุ, ที่อยู่: 138 หมู่ 43 ตำบลพระธาตุ อำเภอเชียงคาน จังหวัดน่าน",
"วัดหัวน้ำ ตำบลพระธาตุ, ที่อยู่: 139 หมู่ 44 ตำบลพระธาตุ อำเภอเชียงคาน จังหวัดน่าน",
"วัดหัวเวียงเหนือ ตำบลฝายแก้ว",
"วัดป่าหัด ตำบลม่วงตี๊ด",
"วัดม่วงตึ๊ด ตำบลม่วงตี๊ด",
"วัดร้องตอง ตำบลม่วงตี๊ด",
"วัดศรีบุญเรือง ตำบลม่วงตี๊ด",
"วัดทุ่งเม็ง ตำบลเมืองจัง",
"วัดเมืองจังใต้ ตำบลเมืองจัง",
"วัดหาดเค็ดบน ตำบลเมืองจัง",
"วัดหาดเค็ดล่าง ตำบลเมืองจัง",
"วัดหาดผาคำ ตำบลเมืองจัง",
"วัดราษฎร์ในอำเภอบ่อเกลือ",
"วัดราษฎร์มหานิกาย",
"วัดนากลุ่ม ตำบลบ่อเกลือใต้",
"วัดนาคอก ตำบลบ่อเกลือใต้",
"วัดนาเปลื่อง (นาเปลื้อง) ตำบลบ่อเกลือใต้",
"วัดบ่อหลวง ตำบลบ่อเกลือใต้",
"วัดบ่อหยวก ตำบลบ่อเกลือเหนือ",
"วัดสะปัน ตำบลบ่อเกลือเหนือ",
"วัดสะว้า ตำบลบ่อเกลือเหนือ",
"วัดราษฎร์ในอำเภอเชียงกลาง",
"วัดราษฎร์มหานิกาย",
"วัดเจดีย์ (คาว) ตำบลเชียงกลาง",
"วัดเชียงโคม ตำบลเชียงกลาง",
"วัดม่วงสุม ตำบลเชียงกลาง",
"วัดศรีบุญเรือง ตำบลเชียงกลาง",
"วัดศรีอุดม ตำบลเชียงกลาง",
"วัดดอนแท่น ตำบลเชียงคาน",
"วัดใหม่วังเคียน ตำบลเชียงคาน",
"วัดนาหนุน ตำบลเปือ",
"วัดน้ำอ้อ ตำบลเปือ",
"วัดประดิษฐ์ ตำบลเปือ",
"วัดรัชดา ตำบลเปือ",
"วัดศรีชุม ตำบลเปือ",
"วัดหนองแดง ตำบลเปือ",
"วัดหนองผุก ตำบลเปือ",
"วัดคันนา ตำบลพญาแก้ว",
"วัดน้ำคา ตำบลพญาแก้ว",
"วัดกลาง ตำบลพระธาตุ",
"วัดดอนแก้ว ตำบลพระธาตุ",
"วัดพร้าว ตำบลพระธาตุ",
"วัดสร้อยพร้าว ตำบลพระธาตุ",
"วัดหัวน้ำ ตำบลพระธาตุ",
"วัดชัยมงคล ตำบลพระพุทธบาท",
"วัดซาววา ตำบลพระพุทธบาท",
"วัดไทรหลวง ตำบลพระพุทธบาท",
"วัดพรมเมืองสวรรค์ ตำบลพระพุทธบาท",
"วัดวังทอง ตำบลพระพุทธบาท",
"วัดศรี ตำบลพระพุทธบาท",
"วัดอ้อใต้ ตำบลพระพุทธบาท",
"วัดราษฎร์ธรรมยุติกนิกาย",
"วัดไชยสถาน ตำบลพระพุทธบาท",
"วัดราษฎร์ในอำเภอท่าวังผา",
"วัดราษฎร์มหานิกาย",
"วัดนาเผือก ตำบลจอมพระ",
"วัดนาฝ่า ตำบลจอมพระ",
"วัดน้ำฮาว ตำบลจอมพระ",
"วัดพิกุลทอง ตำบลจอมพระ",
"วัดยู้ ตำบลจอมพระ",
"วัดใหม่ ตำบลจอมพระ",
"วัดจักรวรรณ ตำบลตาลชุม",
"วัดดอนแก่ง ตำบลตาลชุม",
"วัดดอนชัย (สบสาย) ตำบลตาลชุม",
"วัดตาลชุม ตำบลตาลชุม",
"วัดสบหนอง ตำบลตาลชุม",
"วัดสุคันธาราม (ปง) ตำบลตาลชุม",
"วัดห้วยแขม ตำบลตาลชุม",
"วัดมังคลาราม ตำบลท่าวังผา",
"วัดศิลามงคล ตำบลท่าวังผา",
"วัดสุทธาราม ตำบลท่าวังผา",
"วัดอุทัยราษฎร์ ตำบลท่าวังผา",
"วัดดอนแก้ว ตำบลป่าคา",
"วัดนิโครธาราม (ต้นฮ่าง) ตำบลป่าคา",
"วัดฝ่ายมูล ตำบลป่าคา",
"วัดสบย่าง ตำบลป่าคา",
"วัดหนองบัว ตำบลป่าคา",
"วัดหนองม่วง ตำบลป่าคา",
"วัดราษฎร์อุดม ตำบลผาตอ",
"วัดวังทอง ตำบลผาตอ",
"วัดแหน ตำบลผาตอ",
"วัดเชียงยืน ตำบลยม",
"วัดทุ่งฆ้อง ตำบลยม",
"วัดน้ำไคร้ ตำบลยม",
"วัดสันติการาม ตำบลยม",
"วัดพระธาตุจอมพริก ตำบลยม",
"วัดโพธิ์ไทร ตำบลยม",
"วัดศรีมงคล ตำบลยม",
"วัดเชียงแล ตำบลริม",
"วัดป่าไคร้ ตำบลริม",
"วัดปูคา ตำบลริม",
"วัดศิริธาดา ตำบลริม",
"วัดสุวรรณาวาส ตำบลริม",
"วัดดอนตัน ตำบลศรีภูมิ",
"วัดดอนมูล ตำบลศรีภูมิ",
"วัดพุ่มมาลา ตำบลศรีภูมิ",
"วัดโพธิวราราม ตำบลศรีภูมิ",
"วัดอัมพวัน ตำบลศรีภูมิ",
"วัดชนะไพรี ตำบลแสนทอง",
"วัดนาทราย ตำบลแสนทอง",
"วัดนาหนุน ตำบลแสนทอง",
"วัดปิตุราษฎร์ ตำบลแสนทอง",
"วัดไพรสณฑ์ ตำบลแสนทอง",
"วัดราษฎร์ธรรมยุตนิกาย",
"วัดพระธาตุจอมนาง ตำบลจอมพระ",
"สำนักสงฆ์เวียงหลวงภูคาธัมมิกกาวาส ตำบลยม",
"วัดราษฎร์ในอำเภอทุ่งช้าง",
"วัดราษฎร์มหานิกาย",
"วัดทุ่งสุน ตำบลงอบ",
"วัดศรีดอนชัย ตำบลงอบ",
"วัดทุ่งผึ้ง ตำบลทุ่งช้าง",
"วัดราษฎร์บำรุง ตำบลทุ่งช้าง",
"วัดสุขศรี ตำบลทุ่งช้าง",
"วัดดอนชัย ตำบลปอน",
"วัดไชยคำ ตำบลและ",
"วัดดวงคำ ตำบลและ",
"วัดดอนชัย ตำบลและ",
"วัดเฟือยลุง ตำบลและ",
"วัดวังผา ตำบลและ",
"วัดสันกลาง ตำบลและ",
"วัดราษฎร์ในอำเภอนาน้อย",
"วัดราษฎร์มหานิกาย",
"วัดเชียงของ ตำบลเชียงของ",
"วัดนาเกลือ ตำบลเชียงของ",
"วัดน้ำหิน ตำบลเชียงของ",
"วัดดอนไชย ตำบลนาน้อย",
"วัดนาน้อย ตำบลนาน้อย",
"วัดนาราบ ตำบลนาน้อย",
"วัดนาหลวง ตำบลนาน้อย",
"วัดบุ้ง ตำบลนาน้อย",
"วัดหัวทุ่ง ตำบลนาน้อย",
"วัดเปา ตำบลน้ำตก",
"วัดนาไค้ ตำบลบัวใหญ่",
"วัดนาแหน ตำบลบัวใหญ่",
"วัดสบหลม ตำบลบัวใหญ่"

]

# 4. แปลงข้อความเป็นเวกเตอร์ และเพิ่มลงใน Qdrant
def add_documents_to_qdrant(documents):
    embedding_model = SentenceTransformer("all-MiniLM-L6-v2")  # โหลดโมเดลสำหรับทำ Embedding
    vectors = embedding_model.encode(documents).tolist()  # แปลงข้อความเป็นเวกเตอร์

    # เพิ่มข้อมูลลง Qdrant
    points = [PointStruct(id=i, vector=vectors[i], payload={"text": documents[i]}) for i in range(len(documents))]
    qdrant_client.upsert(collection_name="documents", points=points)

# 5. สร้างฟังก์ชันการค้นหาเอกสาร
def search_documents(query):
    embedding_model = SentenceTransformer("all-MiniLM-L6-v2")
    query_vector = embedding_model.encode([query])[0].tolist()
    search_results = qdrant_client.search(
        collection_name="documents",
        query_vector=query_vector,
        limit=2  # ดึงเอกสารที่เกี่ยวข้อง 2 อันดับแรก
    )
    return [hit.payload["text"] for hit in search_results]

# 6. สร้างฟังก์ชันการสร้างคำตอบด้วย Groq
def generate_answer(query):
    # ค้นหาข้อมูลที่เกี่ยวข้องจาก Qdrant
    retrieved_docs = search_documents(query)

    # รวมข้อมูลเข้าไปใน Prompt
    context = "\n".join(retrieved_docs)
    prompt = [
        {"role": "system", "content": "คุณเป็นผู้ช่วยที่เชี่ยวชาญเกี่ยวกับข้อมูลในเอกสาร จงตอบคำถามอย่างกระชับและถูกต้อง"},
        {"role": "user", "content": f"ข้อมูลอ้างอิง:\n{context}\n\nคำถาม: {query}\n\nคำตอบ:"}
    ]

    # เรียก Groq API
    groq_client = Groq(api_key=os.getenv("GROQ_API_KEY"))
    response = groq_client.chat.completions.create(
        model="llama-3.3-70b-versatile",
        messages=prompt
    )

    return response.choices[0].message.content

# 7. สร้างอินเทอร์เฟซด้วย Streamlit
def main():
    st.title("RAG Chatbot สำหรับข้อมูลวัดในจังหวัดน่าน")
    st.write("สวัสดี! ฉันคือ Chatbot ที่ช่วยตอบคำถามเกี่ยวกับวัดในจังหวัดน่าน")

    # เพิ่มข้อมูลเอกสารลงใน Qdrant
    add_documents_to_qdrant(documents)
    st.success("ข้อมูลเอกสารพร้อมใช้งานแล้ว!")

    # รับคำถามจากผู้ใช้
    query = st.text_input("คุณ: ", placeholder="พิมพ์คำถามของคุณที่นี่...")

    if st.button("ส่ง"):
        if query:
            # สร้างคำตอบ
            answer = generate_answer(query)
            st.write("Bot:", answer)
        else:
            st.warning("กรุณาพิมพ์คำถามก่อนส่ง")

# 8. เรียกใช้แอปพลิเคชัน
if __name__ == "__main__":
    main()